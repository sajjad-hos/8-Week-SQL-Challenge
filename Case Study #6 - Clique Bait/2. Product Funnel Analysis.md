## Case Study #6 - Clique Bait - 2. Product Funnel Analysis | Questions | Solutions | Result

#### Q1: Using a single SQL query - create a new output table which has the following details:
- How many times was each product viewed?
- How many times was each product added to cart?
- How many times was each product added to a cart but not purchased (abandoned)?
- How many times was each product purchased?

#### ðŸ§  My Approach & Solution:
- Identified all visits where a purchase had occurred using a CTE.
- Counted for each product how many times it was viewed, added to cart, abandoned, or purchased by joining the events table with page_hierarchy for product info and with the purchases CTE.
- Grouped the results by product to summarize views, cart adds, abandoned carts, and purchases.

````sql
WITH purchases AS (
    SELECT DISTINCT visit_id
    FROM clique_bait.events
    WHERE event_type = 3  -- Purchase
)
SELECT 
    ph.product_id,
    ph.page_name AS product_name,
    ph.product_category,
    COUNT(*) FILTER (WHERE e.event_type = 1) AS product_views,
    COUNT(*) FILTER (WHERE e.event_type = 2) AS product_added_to_cart,
    COUNT(*) FILTER (WHERE e.event_type = 2 AND p.visit_id IS NULL) AS product_abandoned,
    COUNT(*) FILTER (WHERE e.event_type = 2 AND p.visit_id IS NOT NULL) AS product_purchased
FROM clique_bait.events e
INNER JOIN clique_bait.page_hierarchy ph ON e.page_id = ph.page_id
LEFT JOIN purchases p ON e.visit_id = p.visit_id
WHERE ph.product_id IS NOT NULL
GROUP BY ph.product_id, ph.page_name, ph.product_category
ORDER BY ph.product_id;
  ````

#### ðŸ“Š Query Result & Insights:
| product_id | product_name   | product_category | product_views | product_added_to_cart | product_abandoned | product_purchased |
| ---------- | -------------- | ---------------- | ------------- | --------------------- | ----------------- | ----------------- |
| 1          | Salmon         | Fish             | 1559          | 938                   | 227               | 711               |
| 2          | Kingfish       | Fish             | 1559          | 920                   | 213               | 707               |
| 3          | Tuna           | Fish             | 1515          | 931                   | 234               | 697               |
| 4          | Russian Caviar | Luxury           | 1563          | 946                   | 249               | 697               |
| 5          | Black Truffle  | Luxury           | 1469          | 924                   | 217               | 707               |
| 6          | Abalone        | Shellfish        | 1525          | 932                   | 233               | 699               |
| 7          | Lobster        | Shellfish        | 1547          | 968                   | 214               | 754               |
| 8          | Crab           | Shellfish        | 1564          | 949                   | 230               | 719               |
| 9          | Oyster         | Shellfish        | 1568          | 943                   | 217               | 726               |

- Oyster (1568 views) and Crab (1564 views) were the most viewed products, showing strong user interest.
- Lobster (968 adds) and Russian Caviar (946 adds) were the top products users tried to purchase.
- Russian Caviar had the highest cart abandonment (249), indicating users often added it but did not complete the purchase.
- Lobster led in purchases (754), showing it had the best conversion from cart to purchase.

---
#### Q2: Additionally, create another table which further aggregates the data for the above points but this time for each product category instead of individual products.
#### ðŸ§  My Approach & Solution:
- Identified all visits where a purchase had occurred using a CTE.
- Aggregated product events by category by joining events with product information and purchases, and counted page views, cart adds, abandoned carts, and purchases.
- Grouped the results by product_category to summarize total views, cart adds, abandoned carts, and purchases per category.

````sql
WITH purchases AS (
    SELECT DISTINCT visit_id
    FROM clique_bait.events
    WHERE event_type = 3  -- Purchase
)
SELECT 
    ph.product_category,
    COUNT(*) FILTER (WHERE e.event_type = 1) AS total_views,
    COUNT(*) FILTER (WHERE e.event_type = 2) AS total_added_to_cart,
    COUNT(*) FILTER (WHERE e.event_type = 2 AND p.visit_id IS NULL) AS total_abandoned,
    COUNT(*) FILTER (WHERE e.event_type = 2 AND p.visit_id IS NOT NULL) AS total_purchased
FROM clique_bait.events e
INNER JOIN clique_bait.page_hierarchy ph ON e.page_id = ph.page_id
LEFT JOIN purchases p ON e.visit_id = p.visit_id
WHERE ph.product_category IS NOT NULL
GROUP BY ph.product_category
ORDER BY ph.product_category;
  ````

#### ðŸ“Š Query Result & Insights:
| product_category | total_views | total_added_to_cart | total_abandoned | total_purchased |
| ---------------- | ----------- | ------------------- | --------------- | --------------- |
| Fish             | 4633        | 2789                | 674             | 2115            |
| Luxury           | 3032        | 1870                | 466             | 1404            |
| Shellfish        | 6204        | 3792                | 894             | 2898            |

- Shellfish products were the most popular with the highest views and purchases.
- Fish had good engagement, and Luxury items had the most cart abandonments!
---
#### Q3: Use your 2 new output tables - answer the following questions:
#### Q3.1: Which product had the most views, cart adds and purchases?
#### ðŸ§  My Approach & Solution:

#### Top product by views:

````sql
WITH product_table AS (
    WITH purchases AS (
    SELECT DISTINCT visit_id
    FROM clique_bait.events
    WHERE event_type = 3  -- Purchase
)
SELECT 
    ph.product_id,
    ph.page_name AS product_name,
    ph.product_category,
    COUNT(*) FILTER (WHERE e.event_type = 1) AS product_views,
    COUNT(*) FILTER (WHERE e.event_type = 2) AS product_added_to_cart,
    COUNT(*) FILTER (WHERE e.event_type = 2 AND p.visit_id IS NULL) AS product_abandoned,
    COUNT(*) FILTER (WHERE e.event_type = 2 AND p.visit_id IS NOT NULL) AS product_purchased
FROM clique_bait.events e
INNER JOIN clique_bait.page_hierarchy ph ON e.page_id = ph.page_id
LEFT JOIN purchases p ON e.visit_id = p.visit_id
WHERE ph.product_id IS NOT NULL
GROUP BY ph.product_id, ph.page_name, ph.product_category
ORDER BY ph.product_id
)

SELECT product_name, product_views
FROM product_table
ORDER BY product_views DESC
LIMIT 1;
  ````

#### ðŸ“Š Query Result & Insights:
| product_name | product_views |
| ------------ | ------------- |
| Oyster       | 1568          |

- The product Oyster had 1568 views.


#### Top product by cart adds:

````sql
WITH product_table AS (
    WITH purchases AS (
    SELECT DISTINCT visit_id
    FROM clique_bait.events
    WHERE event_type = 3  -- Purchase
)
SELECT 
    ph.product_id,
    ph.page_name AS product_name,
    ph.product_category,
    COUNT(*) FILTER (WHERE e.event_type = 1) AS product_views,
    COUNT(*) FILTER (WHERE e.event_type = 2) AS product_added_to_cart,
    COUNT(*) FILTER (WHERE e.event_type = 2 AND p.visit_id IS NULL) AS product_abandoned,
    COUNT(*) FILTER (WHERE e.event_type = 2 AND p.visit_id IS NOT NULL) AS product_purchased
FROM clique_bait.events e
INNER JOIN clique_bait.page_hierarchy ph ON e.page_id = ph.page_id
LEFT JOIN purchases p ON e.visit_id = p.visit_id
WHERE ph.product_id IS NOT NULL
GROUP BY ph.product_id, ph.page_name, ph.product_category
ORDER BY ph.product_id
)

SELECT product_name, product_added_to_cart
FROM product_table
ORDER BY product_added_to_cart DESC
LIMIT 1;
  ````

#### ðŸ“Š Query Result & Insights:
| product_name | product_added_to_cart |
| ------------ | --------------------- |
| Lobster      | 968                   |

- The product Lobster was added 1568 times to the cart.

#### Top product by purchases:

````sql
WITH product_table AS (
    WITH purchases AS (
    SELECT DISTINCT visit_id
    FROM clique_bait.events
    WHERE event_type = 3  -- Purchase
)
SELECT 
    ph.product_id,
    ph.page_name AS product_name,
    ph.product_category,
    COUNT(*) FILTER (WHERE e.event_type = 1) AS product_views,
    COUNT(*) FILTER (WHERE e.event_type = 2) AS product_added_to_cart,
    COUNT(*) FILTER (WHERE e.event_type = 2 AND p.visit_id IS NULL) AS product_abandoned,
    COUNT(*) FILTER (WHERE e.event_type = 2 AND p.visit_id IS NOT NULL) AS product_purchased
FROM clique_bait.events e
INNER JOIN clique_bait.page_hierarchy ph ON e.page_id = ph.page_id
LEFT JOIN purchases p ON e.visit_id = p.visit_id
WHERE ph.product_id IS NOT NULL
GROUP BY ph.product_id, ph.page_name, ph.product_category
ORDER BY ph.product_id
)

SELECT product_name, product_purchased
FROM product_table
ORDER BY product_purchased DESC
LIMIT 1;
  ````

#### ðŸ“Š Query Result & Insights:
| product_name | product_purchased |
| ------------ | ----------------- |
| Lobster      | 754               |

- The product Lobster was purchased 754 times in total.
---
#### Q3.2: Which product was most likely to be abandoned?
#### ðŸ§  My Approach & Solution:

````sql
WITH product_table AS (
    WITH purchases AS (
    SELECT DISTINCT visit_id
    FROM clique_bait.events
    WHERE event_type = 3  -- Purchase
)
SELECT 
    ph.product_id,
    ph.page_name AS product_name,
    ph.product_category,
    COUNT(*) FILTER (WHERE e.event_type = 1) AS product_views,
    COUNT(*) FILTER (WHERE e.event_type = 2) AS product_added_to_cart,
    COUNT(*) FILTER (WHERE e.event_type = 2 AND p.visit_id IS NULL) AS product_abandoned,
    COUNT(*) FILTER (WHERE e.event_type = 2 AND p.visit_id IS NOT NULL) AS product_purchased
FROM clique_bait.events e
INNER JOIN clique_bait.page_hierarchy ph ON e.page_id = ph.page_id
LEFT JOIN purchases p ON e.visit_id = p.visit_id
WHERE ph.product_id IS NOT NULL
GROUP BY ph.product_id, ph.page_name, ph.product_category
ORDER BY ph.product_id
)

SELECT product_name, product_abandoned
FROM product_table
ORDER BY product_abandoned DESC
LIMIT 1;

  ````

#### ðŸ“Š Query Result & Insights:
| product_name   | product_abandoned |
| -------------- | ----------------- |
| Russian Caviar | 249               |

- The product Russian Caviar had the highest number of abandoned carts, with 249 instances.
---
#### Q3.3: Which product had the highest view to purchase percentage?
#### ðŸ§  My Approach & Solution:

````sql
WITH product_table AS (
    WITH purchases AS (
        SELECT DISTINCT visit_id
        FROM clique_bait.events
        WHERE event_type = 3  -- Purchase
    )
    SELECT 
        ph.product_id,
        ph.page_name AS product_name,
        COUNT(*) FILTER (WHERE e.event_type = 1) AS product_views,
        COUNT(*) FILTER (WHERE e.event_type = 2) AS product_added_to_cart,
        COUNT(*) FILTER (WHERE e.event_type = 2 AND p.visit_id IS NULL) AS product_abandoned,
        COUNT(*) FILTER (WHERE e.event_type = 2 AND p.visit_id IS NOT NULL) AS product_purchased
    FROM clique_bait.events e
    INNER JOIN clique_bait.page_hierarchy ph ON e.page_id = ph.page_id
    LEFT JOIN purchases p ON e.visit_id = p.visit_id
    WHERE ph.product_id IS NOT NULL
    GROUP BY ph.product_id, ph.page_name
)
SELECT 
    product_name,
    product_views,
    product_purchased,
    CONCAT(ROUND((product_purchased::NUMERIC / NULLIF(product_views, 0)) * 100, 2), '%') AS view_to_purchase_rate
FROM product_table
ORDER BY (product_purchased::NUMERIC / NULLIF(product_views, 0)) DESC
LIMIT 1;

  ````

#### ðŸ“Š Query Result & Insights:
| product_name | product_views | product_purchased | view_to_purchase_rate |
| ------------ | ------------- | ----------------- | --------------------- |
| Lobster      | 1547          | 754               | 48.74%                |

- The Lobster product had the highest conversion from views to purchases at 48.74%.
---
#### Q3.4: What is the average conversion rate from view to cart add?
#### ðŸ§  My Approach & Solution:

````sql
WITH product_table AS (
    WITH purchases AS (
        SELECT DISTINCT visit_id
        FROM clique_bait.events
        WHERE event_type = 3
    )
    SELECT 
        ph.product_id,
        ph.page_name AS product_name,
        COUNT(*) FILTER (WHERE e.event_type = 1) AS product_views,
        COUNT(*) FILTER (WHERE e.event_type = 2) AS product_added_to_cart
    FROM clique_bait.events e
    INNER JOIN clique_bait.page_hierarchy ph ON e.page_id = ph.page_id
    LEFT JOIN purchases p ON e.visit_id = p.visit_id
    WHERE ph.product_id IS NOT NULL
    GROUP BY ph.product_id, ph.page_name
)
SELECT 
    CONCAT(ROUND(AVG(product_added_to_cart::NUMERIC / NULLIF(product_views, 0)) * 100, 2), '%') 
    AS avg_view_to_cart_conversion
FROM product_table;
  ````

#### ðŸ“Š Query Result & Insights:
| avg_view_to_cart_conversion |
| --------------------------- |
| 60.95%                      |

- On average, 60.95% of product views result in an add-to-cart action.
---
#### Q3.5: What is the average conversion rate from cart add to purchase?
#### ðŸ§  My Approach & Solution:

````sql
WITH product_table AS (
    WITH purchases AS (
        SELECT DISTINCT visit_id
        FROM clique_bait.events
        WHERE event_type = 3
    )
    SELECT 
        ph.product_id,
        ph.page_name AS product_name,
        COUNT(*) FILTER (WHERE e.event_type = 2) AS product_added_to_cart,
        COUNT(*) FILTER (WHERE e.event_type = 2 AND p.visit_id IS NOT NULL) AS product_purchased
    FROM clique_bait.events e
    INNER JOIN clique_bait.page_hierarchy ph ON e.page_id = ph.page_id
    LEFT JOIN purchases p ON e.visit_id = p.visit_id
    WHERE ph.product_id IS NOT NULL
    GROUP BY ph.product_id, ph.page_name
)
SELECT CONCAT(ROUND(AVG(product_purchased::NUMERIC / NULLIF(product_added_to_cart, 0)) * 100, 2), '%') AS avg_cart_to_purchase_conversion
FROM product_table;
  ````

#### ðŸ“Š Query Result & Insights:
| avg_cart_to_purchase_conversion |
| ------------------------------- |
| 75.93%                          |

- On average, 75.93% of items added to the cart are ultimately purchased.
---
