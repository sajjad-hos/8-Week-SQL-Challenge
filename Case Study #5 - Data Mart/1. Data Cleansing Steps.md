## Case Study #5 - Data Mart - 1. Data Cleansing Steps | Solutions | Result

In a single query, perform the following operations and generate a new table in the `data_mart` schema named `clean_weekly_sales`:
- Convert the `week_date` to a `DATE` format
- Add a `week_number` as the second column for each `week_date` value, for example any value from the 1st of January to 7th of January will be 1, 8th to 14th will be 2 etc
- Add a `month_number` with the calendar month for each `week_date` value as the 3rd column
- Add a `calendar_year` column as the 4th column containing either 2018, 2019 or 2020 values
- Add a new column called `age_band` after the original `segment` column using the following mapping on the number inside the `segment` value

| Segment | Age Band       |
|---------|----------------|
| 1       | Young Adults   |
| 2       | Middle Aged    |
| 3 or 4  | Retirees       |

- Add a new `demographic` column using the following mapping for the first letter in the `segment` values:

| Segment | Demographic |
|---------|-------------|
| C       | Couples     |
| F       | Families    |

- Ensure all `null` string values with an `"unknown"` string value in the original `segment` column as well as the new `age_band` and `demographic` columns
- Generate a new `avg_transaction` column as the `sales` value divided by `transactions` rounded to 2 decimal places for each record


#### ðŸ§  My Approach & Solution:

The table below shows the data cleansing and transformation rules applied to generate the table `data_mart.clean_weekly_sales` from `data_mart.weekly_sales`.

| **Column No.** | **Column Name**       | **Transformation Rule Applied**                                                                 |
|-------|------------------|------------------------------------------------------------------------------------------|
| 1     | `week_date`      | Convert to `DATE` using `TO_DATE(week_date, 'DD/MM/YY')`                                |
| 2     | `week_number`*   | Extract **week of year** using `EXTRACT(WEEK FROM week_date)`                           |
| 3     | `month_number`*  | Extract **month number** using `EXTRACT(MONTH FROM week_date)`                          |
| 4     | `calendar_year`* | Extract **year** using `EXTRACT(YEAR FROM week_date)`                                   |
| 5     | `region`         | No changes required                                                                             |
| 6     | `platform`       | No changes required                                                                              |
| 7     | `segment`        | Replace `NULL` or empty values with `'unknown'`                                         |
| 8     | `age_band`*      | Derived from the **last digit** of `segment`: `'1'` â†’ **Young Adults**, `'2'` â†’ **Middle Aged**, `'3'` or `'4'` â†’ **Retirees**, Else â†’ **unknown** |
| 9     | `demographic`*   | Derived from the **first character** of `segment`: `'C'` â†’ **Couples**, `'F'` â†’ **Families**, Else â†’ **unknown** |
| 10    | `customer_type`  | No changes required                                                                               |
| 11    | `transactions`   | No changes required                                                                              |
| 12    | `sales`          | No changes required                                    |
| 13    | `avg_transaction`* | Compute as `ROUND(sales::NUMERIC / NULLIF(transactions,0), 2)`                        |


````sql
-- Drop table if it exists
DROP TABLE IF EXISTS data_mart.clean_weekly_sales;

-- Create the table with proper data types
CREATE TABLE data_mart.clean_weekly_sales (
    week_date DATE,
    week_number INT,
    month_number INT,
    calendar_year INT,
    region TEXT,
    platform TEXT,
    segment TEXT,
    age_band TEXT,
    demographic TEXT,
    customer_type TEXT,
    transactions INT,
    sales BIGINT,
    avg_transaction NUMERIC(10,2)
);

-- Populate the table from weekly_sales
INSERT INTO data_mart.clean_weekly_sales
SELECT
	-- 1. Convert week_date to DATE format
    TO_DATE(week_date, 'DD/MM/YY') AS week_date,
    -- 2. Add a `week_number` (ISO week of year: 1â€“52/53) as the second column for each `week_date`.
    EXTRACT(WEEK FROM TO_DATE(week_date, 'DD/MM/YY'))::INT AS week_number,
    -- 3. Add a `month_number` with the calendar month for each `week_date` value as the 3rd column.
    EXTRACT(MONTH FROM TO_DATE(week_date, 'DD/MM/YY'))::INT AS month_number,
    -- 4. Add a `calendar_year` column as the 4th column containing either 2018, 2019 or 2020 values.
    EXTRACT(YEAR FROM TO_DATE(week_date, 'DD/MM/YY'))::INT AS calendar_year,
    -- 5. No changes required.
    region,
    -- 6. No changes required.
    platform,
    -- 7. Replace NULL or empty values with 'unknown'
    COALESCE(NULLIF(segment, ''), 'unknown') AS segment,
    -- 8. Add a new `age_band` column derived from the last digit of the `segment` value. Null or empty `segment` values are replaced with `'unknown'`. 
    CASE 
        WHEN RIGHT(COALESCE(NULLIF(segment, ''), '0'), 1) = '1' THEN 'Young Adults'
        WHEN RIGHT(COALESCE(NULLIF(segment, ''), '0'), 1) = '2' THEN 'Middle Aged'
        WHEN RIGHT(COALESCE(NULLIF(segment, ''), '0'), 1) IN ('3','4') THEN 'Retirees'
        ELSE 'unknown'
    END AS age_band,
    -- 9. Add a new `demographic` column derived from the first letter of the `segment` value. Null or empty `segment` values are replaced with `'unknown'`. 
    CASE
        WHEN LEFT(COALESCE(NULLIF(segment, ''), 'U'), 1) = 'C' THEN 'Couples'
        WHEN LEFT(COALESCE(NULLIF(segment, ''), 'U'), 1) = 'F' THEN 'Families'
        ELSE 'unknown'
    END AS demographic,
    -- 10. No changes required.
    customer_type,
    -- 11. No changes required.
    transactions,
    -- 12. No changes required.
    sales::BIGINT AS sales,
    -- 13. Add a new `avg_transaction` column as the `sales` value divided by `transactions`, rounded to 2 decimal places for each record.
    ROUND(sales::NUMERIC / NULLIF(transactions,0), 2) AS avg_transaction
FROM data_mart.weekly_sales;

-- Preview results with first 10 rows.
SELECT * FROM data_mart.clean_weekly_sales LIMIT 10;

  ````

#### ðŸ“Š Query Result & Insights:
| week_date  | week_number | month_number | calendar_year | region | platform | segment | age_band     | demographic | customer_type | transactions | sales    | avg_transaction |
| ---------- | ----------- | ------------ | ------------- | ------ | -------- | ------- | ------------ | ----------- | ------------- | ------------ | -------- | --------------- |
| 2020-08-31 | 36          | 8            | 2020          | ASIA   | Retail   | C3      | Retirees     | Couples     | New           | 120631       | 3656163  | 30.31           |
| 2020-08-31 | 36          | 8            | 2020          | ASIA   | Retail   | F1      | Young Adults | Families    | New           | 31574        | 996575   | 31.56           |
| 2020-08-31 | 36          | 8            | 2020          | USA    | Retail   | null    | unknown      | unknown     | Guest         | 529151       | 16509610 | 31.20           |
| 2020-08-31 | 36          | 8            | 2020          | EUROPE | Retail   | C1      | Young Adults | Couples     | New           | 4517         | 141942   | 31.42           |
| 2020-08-31 | 36          | 8            | 2020          | AFRICA | Retail   | C2      | Middle Aged  | Couples     | New           | 58046        | 1758388  | 30.29           |
| 2020-08-31 | 36          | 8            | 2020          | CANADA | Shopify  | F2      | Middle Aged  | Families    | Existing      | 1336         | 243878   | 182.54          |
| 2020-08-31 | 36          | 8            | 2020          | AFRICA | Shopify  | F3      | Retirees     | Families    | Existing      | 2514         | 519502   | 206.64          |
| 2020-08-31 | 36          | 8            | 2020          | ASIA   | Shopify  | F1      | Young Adults | Families    | Existing      | 2158         | 371417   | 172.11          |
| 2020-08-31 | 36          | 8            | 2020          | AFRICA | Shopify  | F2      | Middle Aged  | Families    | New           | 318          | 49557    | 155.84          |
| 2020-08-31 | 36          | 8            | 2020          | AFRICA | Retail   | C3      | Retirees     | Couples     | New           | 111032       | 3888162  | 35.02           |
---
