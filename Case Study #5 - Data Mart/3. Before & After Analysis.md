## Case Study #5 - Data Mart - 3. Before & After Analysis | Solutions | Result

This technique is usually used when we inspect an important event and want to inspect the impact before and after a certain point in time. Taking the `week_date` value of `2020-06-15` as the baseline week where the Data Mart sustainable packaging changes came into effect. We would include all `week_date` values for `2020-06-15` as the start of the period after the change and the previous `week_date` values would be before

Using this analysis approach - answer the following questions:

#### Q1: What is the total sales for the 4 weeks before and after `2020-06-15`? What is the growth or reduction rate in actual values and percentage of sales?
#### ðŸ§  My Approach & Solution:
Note: Use the `code` from `Data Cleansing Steps` to create the `clean_weekly_sales` table first. Then, run the queries below to get the results.
````sql
WITH sales_period AS (
    SELECT
        CASE 
            WHEN week_date >= DATE '2020-06-15' - INTERVAL '28 days' AND week_date < DATE '2020-06-15' THEN '4_weeks_before'
            WHEN week_date >= DATE '2020-06-15' AND week_date < DATE '2020-06-15' + INTERVAL '28 days' THEN '4_weeks_after'
        END AS period,
        SUM(sales) AS total_sales
    FROM data_mart.clean_weekly_sales
    WHERE week_date >= DATE '2020-06-15' - INTERVAL '28 days' AND week_date < DATE '2020-06-15' + INTERVAL '28 days'
    GROUP BY period
)
SELECT
    MAX(CASE WHEN period = '4_weeks_before' THEN total_sales END) AS total_sales_before,
    MAX(CASE WHEN period = '4_weeks_after' THEN total_sales END) AS total_sales_after,
    MAX(CASE WHEN period = '4_weeks_after' THEN total_sales END) - MAX(CASE WHEN period = '4_weeks_before' THEN total_sales END) AS change_value,
    ROUND(100.0 * (MAX(CASE WHEN period = '4_weeks_after' THEN total_sales END) - MAX(CASE WHEN period = '4_weeks_before' THEN total_sales END)) 
      / MAX(CASE WHEN period = '4_weeks_before' THEN total_sales END), 2) AS change_percent
FROM sales_period;
  ````

#### ðŸ“Š Query Result & Insights:
| total_sales_before | total_sales_after | change_value | change_percent |
| ------------------ | ----------------- | ------------ | -------------- |
| 2345878357         | 2318994169        | -26884188    | -1.15          |

---
#### Q2: What about the entire 12 weeks before and after?
Note: Use the `code` from `Data Cleansing Steps` to create the `clean_weekly_sales` table first. Then, run the queries below to get the results.
````sql
WITH sales_period AS (
    SELECT
        CASE 
            WHEN week_date >= DATE '2020-06-15' - INTERVAL '84 days' AND week_date < DATE '2020-06-15' THEN '12_weeks_before'
            WHEN week_date >= DATE '2020-06-15' AND week_date < DATE '2020-06-15' + INTERVAL '84 days' THEN '12_weeks_after'
        END AS period,
        SUM(sales) AS total_sales
    FROM data_mart.clean_weekly_sales
    WHERE week_date >= DATE '2020-06-15' - INTERVAL '84 days' AND week_date < DATE '2020-06-15' + INTERVAL '84 days'
    GROUP BY period
)
SELECT
    MAX(CASE WHEN period = '12_weeks_before' THEN total_sales END) AS total_sales_before,
    MAX(CASE WHEN period = '12_weeks_after' THEN total_sales END) AS total_sales_after,
    MAX(CASE WHEN period = '12_weeks_after' THEN total_sales END) - MAX(CASE WHEN period = '12_weeks_before' THEN total_sales END) AS change_value,
    ROUND(100.0 * (MAX(CASE WHEN period = '12_weeks_after' THEN total_sales END) - MAX(CASE WHEN period = '12_weeks_before' THEN total_sales END)) 
      / MAX(CASE WHEN period = '12_weeks_before' THEN total_sales END), 2) AS change_percent
FROM sales_period;
  ````

#### ðŸ“Š Query Result & Insights:
| total_sales_before | total_sales_after | change_value | change_percent |
| ------------------ | ----------------- | ------------ | -------------- |
| 7126273147         | 6973947753        | -152325394   | -2.14          |

---
#### Q3: How do the sale metrics for these 2 periods before and after compare with the previous years in 2018 and 2019?

#### The sale metrics for 4 weeks before and after compare with the previous years in 2018 and 2019:
Note: Use the `code` from `Data Cleansing Steps` to create the `clean_weekly_sales` table first. Then, run the queries below to get the results.
````sql
WITH sales_period AS (
    SELECT
        calendar_year,
        CASE 
            WHEN week_date >= TO_DATE(calendar_year || '-06-15', 'YYYY-MM-DD') - INTERVAL '28 days' AND week_date < TO_DATE(calendar_year || '-06-15', 'YYYY-MM-DD') THEN '4_weeks_before'
            WHEN week_date >= TO_DATE(calendar_year || '-06-15', 'YYYY-MM-DD') AND week_date < TO_DATE(calendar_year || '-06-15', 'YYYY-MM-DD') + INTERVAL '28 days' THEN '4_weeks_after'
        END AS period,
        SUM(sales) AS total_sales
    FROM data_mart.clean_weekly_sales
    WHERE week_date >= TO_DATE(calendar_year || '-06-15', 'YYYY-MM-DD') - INTERVAL '28 days' AND week_date < TO_DATE(calendar_year || '-06-15', 'YYYY-MM-DD') + INTERVAL '28 days'
    GROUP BY calendar_year, period
)
SELECT
    calendar_year,
    MAX(CASE WHEN period = '4_weeks_before' THEN total_sales END) AS total_sales_before,
    MAX(CASE WHEN period = '4_weeks_after' THEN total_sales END) AS total_sales_after,
    MAX(CASE WHEN period = '4_weeks_after' THEN total_sales END) - MAX(CASE WHEN period = '4_weeks_before' THEN total_sales END) AS change_value,
    ROUND(100.0 * (MAX(CASE WHEN period = '4_weeks_after' THEN total_sales END) - MAX(CASE WHEN period = '4_weeks_before' THEN total_sales END))
      / MAX(CASE WHEN period = '4_weeks_before' THEN total_sales END), 2) AS change_percent
FROM sales_period
GROUP BY calendar_year
ORDER BY calendar_year;
  ````

#### ðŸ“Š Query Result & Insights:
| calendar_year | total_sales_before | total_sales_after | change_value | change_percent |
| ------------- | ------------------ | ----------------- | ------------ | -------------- |
| 2018          | 2125140809         | 2129242914        | 4102105      | 0.19           |
| 2019          | 2249989796         | 2252326390        | 2336594      | 0.10           |
| 2020          | 2345878357         | 2318994169        | -26884188    | -1.15          |

---

#### The sale metrics for 12 weeks before and after compare with the previous years in 2018 and 2019:
Note: Use the `code` from `Data Cleansing Steps` to create the `clean_weekly_sales` table first. Then, run the queries below to get the results.
````sql
WITH changes AS (
    SELECT 
        calendar_year,
        week_date,
        SUM(sales) AS total_sales
    FROM clean_weekly_sales
    WHERE week_date BETWEEN '2018-01-01' AND '2020-12-31'
    GROUP BY calendar_year, week_date
),
before_after_changes AS (
    SELECT
        calendar_year,
        SUM(CASE WHEN week_date >= TO_DATE(calendar_year || '-06-15', 'YYYY-MM-DD') - INTERVAL '12 weeks' AND week_date < TO_DATE(calendar_year || '-06-15', 'YYYY-MM-DD') THEN total_sales END) AS before_sales,
        SUM(CASE WHEN week_date >= TO_DATE(calendar_year || '-06-15', 'YYYY-MM-DD') AND week_date < TO_DATE(calendar_year || '-06-15', 'YYYY-MM-DD') + INTERVAL '12 weeks' THEN total_sales END) AS after_sales
    FROM changes
    GROUP BY calendar_year
)
SELECT
    calendar_year,
    before_sales,
    after_sales,
    after_sales - before_sales AS sales_variance,
    ROUND(100.0 * (after_sales - before_sales) / before_sales, 2) AS variance_percentage
FROM before_after_changes
ORDER BY calendar_year;
  ````

#### ðŸ“Š Query Result & Insights:
| calendar_year | before_sales | after_sales | sales_variance | variance_percentage |
| ------------- | ------------ | ----------- | -------------- | ------------------- |
| 2018          | 6396562317   | 6500818510  | 104256193      | 1.63                |
| 2019          | 6883386397   | 6862646103  | -20740294      | -0.30               |
| 2020          | 7126273147   | 6973947753  | -152325394     | -2.14               |

---
